---
phase: 01-infrastructure-setup
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - internal/server/handlers.go
  - templates/partials/article-list.gohtml
  - templates/partials/blog-list.gohtml
autonomous: true

must_haves:
  truths:
    - "Server reads real blog data from ~/.blogwatcher/blogwatcher.db"
    - "Article list shows actual articles from database"
    - "Blog list shows actual blogs from database"
    - "HTMX partial updates return real data"
    - "Empty database state handled gracefully with friendly message"
  artifacts:
    - path: "internal/server/handlers.go"
      provides: "Handlers wired to database"
      contains: "s.db.ListArticles"
    - path: "templates/partials/article-list.gohtml"
      provides: "Article rendering with database data"
      contains: "range .Articles"
    - path: "templates/partials/blog-list.gohtml"
      provides: "Blog rendering with database data"
      contains: "range .Blogs"
  key_links:
    - from: "internal/server/handlers.go"
      to: "internal/storage/database.go"
      via: "s.db method calls"
      pattern: "s\\.db\\.List(Articles|Blogs)"
---

<objective>
Wire server handlers to database layer and verify full stack integration.

Purpose: Connect the server (Plan 02) to the database layer (Plan 01) so that real blog and article data flows from SQLite through templates to the browser. This completes the Phase 1 infrastructure by proving all components work together.

Output: Working web server that displays real data from the existing blogwatcher database, with HTMX partial updates returning actual content.
</objective>

<execution_context>
@/Users/esteban.torres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/esteban.torres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure-setup/01-RESEARCH.md
@.planning/phases/01-infrastructure-setup/01-01-SUMMARY.md
@.planning/phases/01-infrastructure-setup/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire handlers to database queries</name>
  <files>internal/server/handlers.go</files>
  <action>
    Update handlers to use real database queries:

    handleArticleList(w, r):
    - Call s.db.ListArticles(false, nil) to get all articles
    - If error: log error, return 500 with "Database error" message
    - Pass articles to template in data map: {"Articles": articles}
    - Keep HTMX detection logic (partial vs full page)

    handleBlogList(w, r):
    - Call s.db.ListBlogs() to get all blogs
    - If error: log error, return 500 with "Database error" message
    - Pass blogs to template in data map: {"Blogs": blogs}
    - Keep HTMX detection logic (partial vs full page)

    handleIndex(w, r):
    - Fetch both blogs and articles for initial render
    - Pass both to template for sidebar + content area
    - Data map: {"Blogs": blogs, "Articles": articles}

    Error handling should be graceful - log the error server-side but show generic user message.
  </action>
  <verify>
    Run `go build ./cmd/server/...` - should compile.
    Run `go vet ./...` - should pass.
  </verify>
  <done>
    - Handlers call database methods (ListArticles, ListBlogs)
    - Database errors handled gracefully (logged, 500 returned)
    - Real data passed to templates
  </done>
</task>

<task type="auto">
  <name>Task 2: Update templates to render real data</name>
  <files>templates/partials/article-list.gohtml, templates/partials/blog-list.gohtml</files>
  <action>
    Update templates/partials/article-list.gohtml:
    - Use {{range .Articles}} to iterate over articles
    - Display article.Title and article.URL for each
    - Handle empty case: {{if not .Articles}}No articles yet{{end}}
    - Basic structure (styling in Phase 2):
      ```
      {{range .Articles}}
        <div class="article">
          <a href="{{.URL}}" target="_blank">{{.Title}}</a>
        </div>
      {{else}}
        <p>No articles to display.</p>
      {{end}}
      ```

    Create templates/partials/blog-list.gohtml:
    - Use {{range .Blogs}} to iterate over blogs
    - Display blog.Name for each
    - Handle empty case gracefully
    - Basic structure:
      ```
      {{range .Blogs}}
        <div class="blog">{{.Name}}</div>
      {{else}}
        <p>No blogs tracked yet.</p>
      {{end}}
      ```

    Update templates/pages/index.gohtml if needed:
    - Include blog-list partial in a sidebar area
    - Keep article-list in main content area
    - Structure for future layout (detailed styling in Phase 2)
  </action>
  <verify>
    Start server with existing blogwatcher.db.
    Curl localhost:8080/ - should show blog names and article titles from database.
    Curl -H "HX-Request: true" localhost:8080/articles - should show article list fragment.
    Curl -H "HX-Request: true" localhost:8080/blogs - should show blog list fragment.
  </verify>
  <done>
    - Templates render actual blog and article data
    - Empty state handled with friendly messages
    - HTMX partials return data-populated fragments
  </done>
</task>

<task type="auto">
  <name>Task 3: Integration verification and cleanup</name>
  <files>cmd/verify-db/main.go (delete)</files>
  <action>
    Full integration test:
    1. Start server: `go run ./cmd/server`
    2. In browser or curl, verify:
       - localhost:8080 loads and shows real data
       - HTMX triggers article load (check network tab or curl with HX-Request)
       - Blog list appears with names from database
       - Article list shows titles linking to original URLs
    3. Test graceful shutdown (Ctrl+C)

    Cleanup:
    - Delete cmd/verify-db/ directory (was temporary test from Plan 01)
    - Run `go mod tidy` to clean up any unused dependencies

    Document any database-not-found behavior:
    - Server should start but show friendly message in UI
    - Not crash or panic when database missing
  </action>
  <verify>
    Run full integration:
    1. `go build ./cmd/server && ./server &`
    2. `curl -s localhost:8080/ | grep -q "article\|blog"` - should find data
    3. `curl -s -H "HX-Request: true" localhost:8080/articles | grep -v DOCTYPE` - fragment without DOCTYPE
    4. Kill server, confirm clean shutdown
    5. `ls cmd/` - should only show server/, not verify-db/
    6. `go mod tidy && go build ./...` - clean build
  </verify>
  <done>
    - Full stack works: browser -> server -> database -> templates -> response
    - HTMX partial updates return real data as fragments
    - Graceful shutdown confirmed
    - Temporary test code removed
    - Build is clean with no unused dependencies
  </done>
</task>

</tasks>

<verification>
Phase 1 Infrastructure Setup complete when:

1. **INFRA-01 (Go HTTP server):**
   - `go run ./cmd/server` starts server on :8080
   - `curl localhost:8080/` returns HTML page
   - Server shuts down gracefully on SIGINT

2. **INFRA-02 (SQLite database connection):**
   - Server reads from ~/.blogwatcher/blogwatcher.db
   - Blog list shows blogs from database
   - Article list shows articles from database
   - Friendly handling when database missing

3. **INFRA-03 (HTMX dynamic updates):**
   - HTMX library served at /static/htmx.min.js
   - `curl -H "HX-Request: true" localhost:8080/articles` returns HTML fragment
   - Fragment does NOT include DOCTYPE or full page structure
   - Full page request includes HTMX script tag
</verification>

<success_criteria>
- Server serves real data from existing blogwatcher database
- Blog names from database appear in UI
- Article titles from database appear in UI with links to original URLs
- HTMX partial requests return fragments with real data
- Empty database state shows friendly messages (not errors)
- Database missing shows friendly setup message (not crash)
- Clean build with no warnings or unused dependencies
- All Phase 1 requirements (INFRA-01, INFRA-02, INFRA-03) met
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-setup/01-03-SUMMARY.md`
</output>

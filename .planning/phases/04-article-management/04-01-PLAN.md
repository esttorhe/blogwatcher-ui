---
phase: 04-article-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/rss/rss.go
  - internal/scraper/scraper.go
  - internal/scanner/scanner.go
  - internal/storage/database.go
autonomous: true

must_haves:
  truths:
    - "Scanner packages exist and compile without errors"
    - "Database has methods required by scanner (AddArticlesBulk, UpdateBlog, GetExistingArticleURLs)"
    - "Scanner can successfully call RSS parsing and scraper functions"
  artifacts:
    - path: "internal/rss/rss.go"
      provides: "RSS/Atom feed parsing and autodiscovery"
      contains: "func ParseFeed"
    - path: "internal/scraper/scraper.go"
      provides: "HTML scraping fallback for blogs without feeds"
      contains: "func ScrapeBlog"
    - path: "internal/scanner/scanner.go"
      provides: "Blog scanning orchestration using RSS and scraper"
      contains: "func ScanAllBlogs"
    - path: "internal/storage/database.go"
      provides: "Database methods for scanner operations"
      exports: ["AddArticlesBulk", "UpdateBlog", "GetExistingArticleURLs", "UpdateBlogLastScanned"]
  key_links:
    - from: "internal/scanner/scanner.go"
      to: "internal/rss/rss.go"
      via: "import and function call"
      pattern: "rss\\.ParseFeed|rss\\.DiscoverFeedURL"
    - from: "internal/scanner/scanner.go"
      to: "internal/scraper/scraper.go"
      via: "import and function call"
      pattern: "scraper\\.ScrapeBlog"
    - from: "internal/scanner/scanner.go"
      to: "internal/storage/database.go"
      via: "database method calls"
      pattern: "db\\.AddArticlesBulk|db\\.UpdateBlog"
---

<objective>
Set up scanner infrastructure by copying and adapting RSS, scraper, and scanner packages from reference codebase, plus adding required database methods.

Purpose: Enable the UI to trigger blog synchronization (MGMT-04). The scanner orchestrates fetching new articles from RSS feeds or HTML scraping.

Output: Three new packages (rss, scraper, scanner) with updated import paths, plus extended database.go with methods the scanner needs.
</objective>

<execution_context>
@/Users/esteban.torres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/esteban.torres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-article-management/04-RESEARCH.md

# Reference code to copy and adapt
@.reference/blogwatcher/internal/rss/rss.go
@.reference/blogwatcher/internal/scraper/scraper.go
@.reference/blogwatcher/internal/scanner/scanner.go
@.reference/blogwatcher/internal/storage/database.go

# Existing storage to extend
@internal/storage/database.go
@internal/model/model.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy RSS and Scraper packages with updated imports</name>
  <files>
    internal/rss/rss.go
    internal/scraper/scraper.go
  </files>
  <action>
Copy rss.go from .reference/blogwatcher/internal/rss/rss.go to internal/rss/rss.go.
Copy scraper.go from .reference/blogwatcher/internal/scraper/scraper.go to internal/scraper/scraper.go.

Update import paths in both files:
- Change "github.com/Hyaxia/blogwatcher/internal/model" to "github.com/esttorhe/blogwatcher-ui/internal/model"
- Both files use gofeed and goquery which need to be added as dependencies

Add ABOUTME comments at the top of each file explaining its purpose.

Run `go get github.com/mmcdole/gofeed@v1.3.0` and `go get github.com/PuerkitoBio/goquery@v1.10.3` to add dependencies.
  </action>
  <verify>
Run `go build ./internal/rss/...` and `go build ./internal/scraper/...` - both should compile without errors.
  </verify>
  <done>
RSS and scraper packages exist at internal/rss/ and internal/scraper/, compile successfully, and have correct import paths for this project.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add scanner database methods to storage</name>
  <files>internal/storage/database.go</files>
  <action>
Add the following methods to internal/storage/database.go that the scanner package requires:

1. AddArticlesBulk(articles []model.Article) (int, error)
   - Use transaction for atomic insert
   - Return count of inserted articles
   - Copy implementation from reference storage/database.go

2. GetExistingArticleURLs(urls []string) (map[string]struct{}, error)
   - Query articles table for URLs that already exist
   - Return map of existing URLs for deduplication
   - Handle chunking for large URL lists (chunk size 900)
   - Copy implementation from reference

3. UpdateBlog(blog model.Blog) error
   - Update all fields of a blog by ID
   - Needed when scanner discovers feed URL

4. UpdateBlogLastScanned(id int64, lastScanned time.Time) error
   - Update just the last_scanned timestamp
   - Called after each blog is scanned

5. GetBlogByName(name string) (*model.Blog, error)
   - Lookup blog by name (used by ScanBlogByName)

Also add helper functions:
- nullIfEmpty(value string) *string - returns nil for empty strings
- formatTimePtr(value *time.Time) *string - formats time for SQLite
- interfaceSlice(values []string) []interface{} - for query placeholders

These helpers already exist in reference database.go.
  </action>
  <verify>
Run `go build ./internal/storage/...` - should compile without errors.
  </verify>
  <done>
Database has all methods required by scanner: AddArticlesBulk, GetExistingArticleURLs, UpdateBlog, UpdateBlogLastScanned, GetBlogByName.
  </done>
</task>

<task type="auto">
  <name>Task 3: Copy scanner package with updated imports</name>
  <files>internal/scanner/scanner.go</files>
  <action>
Copy scanner.go from .reference/blogwatcher/internal/scanner/scanner.go to internal/scanner/scanner.go.

Update ALL import paths:
- "github.com/Hyaxia/blogwatcher/internal/model" -> "github.com/esttorhe/blogwatcher-ui/internal/model"
- "github.com/Hyaxia/blogwatcher/internal/rss" -> "github.com/esttorhe/blogwatcher-ui/internal/rss"
- "github.com/Hyaxia/blogwatcher/internal/scraper" -> "github.com/esttorhe/blogwatcher-ui/internal/scraper"
- "github.com/Hyaxia/blogwatcher/internal/storage" -> "github.com/esttorhe/blogwatcher-ui/internal/storage"

Add ABOUTME comments at the top explaining:
- This package orchestrates blog scanning using RSS feeds or HTML scraping
- Used by the web UI sync feature to discover new articles

Keep ScanResult struct, ScanBlog, ScanAllBlogs, and ScanBlogByName functions.
Keep convertFeedArticles and convertScrapedArticles helper functions.

Run `go mod tidy` to ensure dependencies are resolved.
  </action>
  <verify>
Run `go build ./internal/scanner/...` - should compile without errors.
Run `go build ./...` - entire project should build.
  </verify>
  <done>
Scanner package exists at internal/scanner/, compiles successfully, and can import rss, scraper, storage, and model packages from this project.
  </done>
</task>

</tasks>

<verification>
1. All three packages compile: `go build ./internal/rss/... ./internal/scraper/... ./internal/scanner/...`
2. Full project builds: `go build ./...`
3. Dependencies are in go.mod: gofeed, goquery
4. Import paths all reference github.com/esttorhe/blogwatcher-ui/internal/...
</verification>

<success_criteria>
- internal/rss/rss.go exists with ParseFeed, DiscoverFeedURL functions
- internal/scraper/scraper.go exists with ScrapeBlog function
- internal/scanner/scanner.go exists with ScanAllBlogs, ScanBlog functions
- internal/storage/database.go has AddArticlesBulk, UpdateBlog, GetExistingArticleURLs, UpdateBlogLastScanned, GetBlogByName methods
- All packages compile without errors
- go.mod includes gofeed and goquery dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/04-article-management/04-01-SUMMARY.md`
</output>

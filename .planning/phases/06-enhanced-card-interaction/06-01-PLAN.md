---
phase: 06-enhanced-card-interaction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/model/model.go
  - internal/storage/database.go
  - internal/thumbnail/thumbnail.go
autonomous: true
user_setup:
  - service: opengraph
    why: "Open Graph image extraction for thumbnail fallback"
    env_vars: []
    dashboard_config: []
    notes: "No setup needed - go get github.com/otiai10/opengraph/v2@v2.2.0"

must_haves:
  truths:
    - "Articles table has thumbnail_url column that accepts nullable text"
    - "Article and ArticleWithBlog models have ThumbnailURL field"
    - "Database queries return thumbnail_url in article results"
    - "Thumbnail extraction package can extract from RSS and Open Graph sources"
  artifacts:
    - path: "internal/model/model.go"
      provides: "ThumbnailURL field on Article and ArticleWithBlog structs"
      contains: "ThumbnailURL"
    - path: "internal/storage/database.go"
      provides: "Schema migration and query updates for thumbnail_url"
      contains: "thumbnail_url"
    - path: "internal/thumbnail/thumbnail.go"
      provides: "Thumbnail extraction with RSS and Open Graph fallback"
      exports: ["ExtractFromRSS", "ExtractFromOpenGraph"]
  key_links:
    - from: "internal/storage/database.go"
      to: "articles table"
      via: "ALTER TABLE ADD COLUMN IF NOT EXISTS"
      pattern: "ADD COLUMN IF NOT EXISTS thumbnail_url"
    - from: "internal/thumbnail/thumbnail.go"
      to: "github.com/otiai10/opengraph/v2"
      via: "import and Fetch call"
      pattern: "opengraph\\.Fetch"
---

<objective>
Add thumbnail infrastructure: database schema, models, and extraction logic.

Purpose: Foundation for thumbnail support - schema must exist before scanner can store thumbnails, models must have field before templates can render.
Output: Database with thumbnail_url column, updated models, reusable thumbnail extraction package.
</objective>

<execution_context>
@/Users/esteban.torres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/esteban.torres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-enhanced-card-interaction/06-RESEARCH.md
@internal/model/model.go
@internal/storage/database.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration and model updates</name>
  <files>internal/model/model.go, internal/storage/database.go</files>
  <action>
1. Update internal/model/model.go:
   - Add `ThumbnailURL string` field to Article struct (after URL field)
   - Add `ThumbnailURL string` field to ArticleWithBlog struct (after URL field)
   - Preserve existing ABOUTME comments

2. Update internal/storage/database.go:
   - Add migration query to run on database open: `ALTER TABLE articles ADD COLUMN IF NOT EXISTS thumbnail_url TEXT;`
   - Create a new ensureMigrations() function that runs after OpenDatabase() verifies connection
   - Call ensureMigrations() at end of OpenDatabase() before returning
   - Update scanArticle() to scan thumbnail_url (nullable, use sql.NullString)
   - Update scanArticleWithBlog() to scan thumbnail_url (nullable, use sql.NullString)
   - Update ListArticlesWithBlog query to include a.thumbnail_url in SELECT
   - Update ListArticlesByReadStatus query to include thumbnail_url in SELECT
   - Update ListArticles query to include thumbnail_url in SELECT
   - Update AddArticlesBulk INSERT to include thumbnail_url column

Note: SQLite 3.33+ supports ADD COLUMN IF NOT EXISTS. modernc.org/sqlite uses SQLite 3.51.2.
  </action>
  <verify>
Run `go build ./...` - should compile without errors.
Run existing tests if any: `go test ./internal/storage/...`
  </verify>
  <done>
Article and ArticleWithBlog have ThumbnailURL field.
Database migration adds thumbnail_url column idempotently.
All database queries properly handle nullable thumbnail_url.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create thumbnail extraction package</name>
  <files>internal/thumbnail/thumbnail.go</files>
  <action>
1. Run `go get github.com/otiai10/opengraph/v2@v2.2.0` to add dependency

2. Create internal/thumbnail/thumbnail.go:
```go
// ABOUTME: Provides thumbnail URL extraction from RSS items and Open Graph meta tags.
// ABOUTME: Used during sync to populate article thumbnails with fallback chain.
package thumbnail

import (
    "context"
    "net/http"
    "strings"
    "time"

    "github.com/mmcdole/gofeed"
    "github.com/otiai10/opengraph/v2"
)

// ExtractFromRSS attempts to extract thumbnail URL from gofeed.Item.
// Checks Item.Image first, then Enclosures for image MIME types.
// Returns empty string if no thumbnail found.
func ExtractFromRSS(item *gofeed.Item) string {
    if item == nil {
        return ""
    }

    // Try Item.Image first (channel-level image reference)
    if item.Image != nil && item.Image.URL != "" {
        return item.Image.URL
    }

    // Try Enclosures (common in RSS 2.0)
    for _, enc := range item.Enclosures {
        if isImageMIMEType(enc.Type) && enc.URL != "" {
            return enc.URL
        }
    }

    return ""
}

// ExtractFromOpenGraph fetches og:image from article page.
// Uses context with timeout to prevent hanging on slow sites.
// Returns empty string on any error (thumbnail is optional).
func ExtractFromOpenGraph(articleURL string, timeout time.Duration) string {
    ctx, cancel := context.WithTimeout(context.Background(), timeout)
    defer cancel()

    intent := opengraph.Intent{
        Context:    ctx,
        Strict:     true, // Only parse <meta> tags
        HTTPClient: &http.Client{Timeout: timeout},
    }

    ogp, err := opengraph.Fetch(articleURL, intent)
    if err != nil {
        return "" // Fail silently - thumbnail is optional
    }

    // Convert relative URLs to absolute
    if err := ogp.ToAbs(); err != nil {
        return ""
    }

    // Return first image if available
    if len(ogp.Image) > 0 && ogp.Image[0].URL != "" {
        return ogp.Image[0].URL
    }

    return ""
}

func isImageMIMEType(mimeType string) bool {
    return strings.HasPrefix(mimeType, "image/")
}
```
  </action>
  <verify>
Run `go build ./internal/thumbnail/...` - should compile.
Run `go mod tidy` to clean up dependencies.
  </verify>
  <done>
Thumbnail package exists with ExtractFromRSS and ExtractFromOpenGraph functions.
Package compiles and imports opengraph/v2 library correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify database queries return thumbnail</name>
  <files>internal/storage/database.go</files>
  <action>
Verify the database layer changes from Task 1 are complete:

1. Ensure ListArticlesWithBlog SELECT includes: a.thumbnail_url
   Query should be:
   ```sql
   SELECT a.id, a.blog_id, a.title, a.url, a.thumbnail_url, a.published_date, a.discovered_date, a.is_read, b.name, b.url
   FROM articles a
   INNER JOIN blogs b ON a.blog_id = b.id
   WHERE a.is_read = ?
   ```

2. Ensure scanArticleWithBlog scans thumbnail_url:
   - Add `thumbnailURL sql.NullString` variable
   - Scan it in the Scan() call
   - Set `article.ThumbnailURL = thumbnailURL.String`

3. Ensure scanArticle also scans thumbnail_url for consistency.

4. Ensure AddArticlesBulk INSERT includes thumbnail_url:
   ```sql
   INSERT INTO articles (blog_id, title, url, thumbnail_url, published_date, discovered_date, is_read)
   VALUES (?, ?, ?, ?, ?, ?, ?)
   ```
   And exec includes article.ThumbnailURL in the values.

Note: This task validates Task 1 was complete. If changes needed, make them now.
  </action>
  <verify>
Run `go build ./...` - full project should compile.
Manual verification: queries include thumbnail_url in SELECT and INSERT.
  </verify>
  <done>
All database queries properly include thumbnail_url.
AddArticlesBulk can insert articles with thumbnail URLs.
ListArticlesWithBlog returns articles with ThumbnailURL populated.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go mod tidy` shows no missing dependencies
3. internal/thumbnail package exists and exports ExtractFromRSS, ExtractFromOpenGraph
4. Article and ArticleWithBlog models have ThumbnailURL field
5. Database queries include thumbnail_url column
</verification>

<success_criteria>
- Article model has ThumbnailURL field
- ArticleWithBlog model has ThumbnailURL field
- Database migration adds thumbnail_url column (idempotent)
- Thumbnail extraction package provides RSS and Open Graph extraction
- All database queries handle thumbnail_url
- Full project compiles
</success_criteria>

<output>
After completion, create `.planning/phases/06-enhanced-card-interaction/06-01-SUMMARY.md`
</output>

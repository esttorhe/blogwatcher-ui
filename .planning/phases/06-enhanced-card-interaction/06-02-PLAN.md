---
phase: 06-enhanced-card-interaction
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - internal/rss/rss.go
  - internal/scanner/scanner.go
  - templates/partials/article-list.gohtml
  - static/styles.css
autonomous: true

must_haves:
  truths:
    - "User can click anywhere on article card and original article opens in new tab"
    - "Article cards display thumbnails when RSS provides media/enclosures"
    - "Article cards display Open Graph images when RSS has no thumbnail"
    - "Article cards display favicon when neither RSS nor Open Graph provide thumbnail"
    - "Thumbnail images render without causing layout shift"
  artifacts:
    - path: "internal/rss/rss.go"
      provides: "FeedArticle with ThumbnailURL extracted from RSS"
      contains: "ThumbnailURL"
    - path: "internal/scanner/scanner.go"
      provides: "Open Graph fallback extraction during sync"
      contains: "thumbnail.ExtractFromOpenGraph"
    - path: "templates/partials/article-list.gohtml"
      provides: "Clickable cards with conditional thumbnail display"
      contains: "stretched-link"
    - path: "static/styles.css"
      provides: "CSS for stretched-link pattern and thumbnail styling"
      contains: "stretched-link"
  key_links:
    - from: "internal/rss/rss.go"
      to: "internal/thumbnail"
      via: "ExtractFromRSS call"
      pattern: "thumbnail\\.ExtractFromRSS"
    - from: "internal/scanner/scanner.go"
      to: "internal/thumbnail"
      via: "ExtractFromOpenGraph call"
      pattern: "thumbnail\\.ExtractFromOpenGraph"
    - from: "templates/partials/article-list.gohtml"
      to: ".ThumbnailURL"
      via: "conditional rendering"
      pattern: "if \\.ThumbnailURL"
---

<objective>
Wire thumbnail extraction into sync pipeline and update UI for clickable cards with thumbnails.

Purpose: Connect the foundation (Plan 01) to actual data flow and user interface. Articles will have thumbnails populated during sync, and users can click entire card to open article.
Output: Fully functional thumbnail display with fallback chain, and clickable article cards.
</objective>

<execution_context>
@/Users/esteban.torres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/esteban.torres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-enhanced-card-interaction/06-RESEARCH.md
@.planning/phases/06-enhanced-card-interaction/06-01-SUMMARY.md
@internal/rss/rss.go
@internal/scanner/scanner.go
@templates/partials/article-list.gohtml
@static/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate thumbnail extraction into sync pipeline</name>
  <files>internal/rss/rss.go, internal/scanner/scanner.go</files>
  <action>
1. Update internal/rss/rss.go:
   - Add ThumbnailURL field to FeedArticle struct
   - Import the thumbnail package: `"github.com/esttorhe/blogwatcher-ui/internal/thumbnail"`
   - In ParseFeed(), after parsing each item, call thumbnail.ExtractFromRSS(item)
   - Set article.ThumbnailURL to the result

   Updated FeedArticle:
   ```go
   type FeedArticle struct {
       Title         string
       URL           string
       ThumbnailURL  string
       PublishedDate *time.Time
   }
   ```

   In ParseFeed loop:
   ```go
   thumbnailURL := thumbnail.ExtractFromRSS(item)
   articles = append(articles, FeedArticle{
       Title:         title,
       URL:           link,
       ThumbnailURL:  thumbnailURL,
       PublishedDate: pickPublishedDate(item),
   })
   ```

2. Update internal/scanner/scanner.go:
   - Import thumbnail package: `"github.com/esttorhe/blogwatcher-ui/internal/thumbnail"`
   - Update convertFeedArticles to pass ThumbnailURL from FeedArticle to model.Article
   - After converting but BEFORE deduplication, check if ThumbnailURL is empty
   - If empty, call thumbnail.ExtractFromOpenGraph(article.URL, 10*time.Second)
   - Use 10 second timeout for Open Graph fetches (balance between speed and reliability)

   Updated convertFeedArticles:
   ```go
   func convertFeedArticles(blogID int64, feedArticles []rss.FeedArticle) []model.Article {
       result := make([]model.Article, 0, len(feedArticles))
       for _, article := range feedArticles {
           thumbnailURL := article.ThumbnailURL
           // Open Graph fallback if RSS didn't provide thumbnail
           if thumbnailURL == "" {
               thumbnailURL = thumbnail.ExtractFromOpenGraph(article.URL, 10*time.Second)
           }
           result = append(result, model.Article{
               BlogID:        blogID,
               Title:         article.Title,
               URL:           article.URL,
               ThumbnailURL:  thumbnailURL,
               PublishedDate: article.PublishedDate,
               IsRead:        false,
           })
       }
       return result
   }
   ```

Note: Open Graph extraction happens during sync, not render time. This avoids N+1 queries.
Note: 10 second timeout is reasonable - sync is background operation, user isn't waiting per-article.
  </action>
  <verify>
Run `go build ./...` - should compile.
Run the server, trigger sync, check logs for any timeout errors.
  </verify>
  <done>
RSS parsing extracts thumbnails from Item.Image and Enclosures.
Scanner falls back to Open Graph extraction when RSS has no thumbnail.
ThumbnailURL flows from RSS -> Scanner -> Database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update article template with stretched-link and thumbnail</name>
  <files>templates/partials/article-list.gohtml</files>
  <action>
Update templates/partials/article-list.gohtml to:

1. Add stretched-link class to article title link (makes entire card clickable)
2. Add conditional thumbnail rendering
3. Keep favicon as fallback when no thumbnail
4. Use onerror handler to hide broken images

Replace the article card loop (inside {{range .Articles}}) with:

```html
<article class="article-card" id="article-{{.ID}}">
    {{if .ThumbnailURL}}
    <img class="article-thumbnail"
         src="{{.ThumbnailURL}}"
         alt=""
         width="120"
         height="80"
         loading="lazy"
         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'; this.onerror=null;">
    <img class="article-favicon article-thumbnail-fallback"
         src="{{faviconURL .BlogURL}}"
         alt=""
         width="32"
         height="32"
         loading="lazy"
         style="display: none;"
         onerror="this.style.visibility='hidden'">
    {{else}}
    <img class="article-favicon"
         src="{{faviconURL .BlogURL}}"
         alt=""
         width="32"
         height="32"
         loading="lazy"
         onerror="this.style.visibility='hidden'">
    {{end}}
    <div class="article-content">
        <a href="{{.URL}}"
           target="_blank"
           rel="noopener noreferrer"
           class="article-title stretched-link">
            {{.Title}}
        </a>
        <div class="article-meta">
            <span class="article-source">{{.BlogName}}</span>
            {{if .PublishedDate}}
            <span class="article-time">{{timeAgo .PublishedDate}}</span>
            {{end}}
        </div>
    </div>
    {{if .IsRead}}
    <button class="action-btn"
            hx-post="/articles/{{.ID}}/unread"
            hx-target="#article-{{.ID}}"
            hx-swap="outerHTML swap:300ms"
            title="Mark as unread">
        Unread
    </button>
    {{else}}
    <button class="action-btn"
            hx-post="/articles/{{.ID}}/read"
            hx-target="#article-{{.ID}}"
            hx-swap="outerHTML swap:300ms"
            title="Mark as read">
        Read
    </button>
    {{end}}
</article>
```

Key changes:
- Added `stretched-link` class to article-title anchor
- Added conditional thumbnail display with {{if .ThumbnailURL}}
- Thumbnail has onerror that hides itself and shows favicon fallback
- Fallback favicon is hidden by default, shown on thumbnail error
- When no ThumbnailURL, shows favicon directly (existing behavior)
  </action>
  <verify>
Run server, view article list - cards should render without errors.
If articles have thumbnails from previous sync, they should display.
New articles from sync should show thumbnails where available.
  </verify>
  <done>
Article cards conditionally display thumbnail or favicon.
Stretched-link class applied to title for full-card click.
Broken thumbnails gracefully fall back to favicon.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CSS for stretched-link and thumbnail styling</name>
  <files>static/styles.css</files>
  <action>
Add the following CSS sections to static/styles.css (at end of file, before final comment if any):

```css
/* ============================================
   Stretched Link Pattern - Full Card Clickable
   ============================================ */
.article-card {
  position: relative; /* Required for ::after positioning */
}

.stretched-link::after {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  z-index: 1;
  content: "";
}

/* Action button must sit above stretched link */
.action-btn {
  position: relative;
  z-index: 2;
}

/* ============================================
   Article Thumbnail Styling
   ============================================ */
.article-thumbnail {
  flex-shrink: 0;
  width: 120px;
  height: 80px;
  object-fit: cover;
  border-radius: 6px;
  background-color: var(--bg-elevated);
}

.article-thumbnail-fallback {
  /* Fallback favicon shown when thumbnail fails */
  width: 32px;
  height: 32px;
  align-items: center;
  justify-content: center;
}

/* Ensure favicon doesn't grow when used as fallback */
.article-favicon {
  flex-shrink: 0;
  width: 32px;
  height: 32px;
  border-radius: 4px;
  background-color: var(--bg-elevated);
}

/* Card with thumbnail needs different alignment */
.article-card:has(.article-thumbnail) {
  align-items: flex-start;
}

/* Card hover should indicate clickability */
.article-card {
  cursor: pointer;
}

/* Prevent text selection when clicking card (but allow on title) */
.article-card {
  user-select: none;
}

.article-title {
  user-select: text;
}
```

Note: The .article-card already has position: relative isn't explicitly set but flex containers work fine.
Actually check existing CSS - .article-card may need position: relative added if not present.

Update existing .article-card rule to add `position: relative;` if not already there.
The existing rule is:
```css
.article-card {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 1rem;
  margin-bottom: 0.5rem;
  background-color: var(--bg-surface);
  border-radius: 8px;
  border: 1px solid var(--border);
  transition: background-color var(--transition-speed) ease;
}
```

Add `position: relative;` and `cursor: pointer;` to this existing rule.
  </action>
  <verify>
Run server, verify:
1. Clicking anywhere on card (not on action button) opens article in new tab
2. Clicking action button marks read/unread (doesn't open article)
3. Thumbnails display with proper aspect ratio (120x80, object-fit: cover)
4. Favicon displays when no thumbnail
5. Cards have pointer cursor indicating clickability
  </verify>
  <done>
Stretched-link CSS makes entire card clickable except action button.
Thumbnails render at 120x80 with object-fit cover (no distortion).
Cursor indicates card is clickable.
Action buttons remain functional above the stretched link.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. Start server: `go run ./cmd/blogwatcher-ui/`
3. Navigate to http://localhost:8080
4. Click "Sync" to fetch new articles with thumbnails
5. Verify articles with RSS images show thumbnails
6. Verify articles without RSS images but with Open Graph show those thumbnails
7. Verify articles with no thumbnail show favicon
8. Click anywhere on a card (not the action button) - article should open in new tab
9. Click action button - should mark read/unread without opening article
10. Thumbnail images should not cause layout shift (fixed dimensions)
</verification>

<success_criteria>
- Clicking anywhere on article card opens original article in new tab (POLISH-01)
- Articles display thumbnails from RSS media/enclosures when available (THUMB-01)
- Articles display Open Graph images as fallback (THUMB-02)
- Articles display favicon when no thumbnail available (THUMB-03)
- Thumbnails render in article cards without layout shift (THUMB-04)
- Action buttons remain functional (not captured by card click)
</success_criteria>

<output>
After completion, create `.planning/phases/06-enhanced-card-interaction/06-02-SUMMARY.md`
</output>

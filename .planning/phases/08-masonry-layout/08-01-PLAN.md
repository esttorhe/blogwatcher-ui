---
phase: 08-masonry-layout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - static/styles.css
  - templates/partials/article-list.gohtml
  - templates/base.gohtml
autonomous: false

must_haves:
  truths:
    - "User sees view toggle button next to theme toggle"
    - "User can click grid view and see articles in masonry-style grid layout"
    - "Grid layout shows 1 column on mobile, 2 on tablet, 3-4 on desktop"
    - "User can switch back to list view and see traditional vertical layout"
    - "View preference persists across browser sessions"
  artifacts:
    - path: "static/styles.css"
      provides: "Grid layout styles and view toggle component styles"
      contains: ".articles-grid"
    - path: "templates/partials/article-list.gohtml"
      provides: "View toggle HTML and articles container with ID"
      contains: "view-toggle"
    - path: "templates/base.gohtml"
      provides: "View toggle JavaScript with localStorage persistence"
      contains: "localStorage.getItem('view')"
  key_links:
    - from: "templates/partials/article-list.gohtml"
      to: "static/styles.css"
      via: "articles-grid class on container"
      pattern: "articles-grid"
    - from: "templates/base.gohtml"
      to: "templates/partials/article-list.gohtml"
      via: "JavaScript targeting #articles-container"
      pattern: "getElementById.*articles-container"
    - from: "templates/base.gohtml"
      to: "localStorage"
      via: "view preference persistence"
      pattern: "localStorage\\.(get|set)Item.*view"
---

<objective>
Implement masonry-style grid layout with view toggle and localStorage persistence.

Purpose: Users can choose between list (current) and grid layouts for browsing articles, with their preference remembered across sessions. This completes the v1.1 UI Polish milestone.

Output: Working view toggle next to theme toggle, responsive CSS Grid layout, view preference persisted in localStorage.
</objective>

<execution_context>
@/Users/esteban.torres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/esteban.torres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-masonry-layout/08-RESEARCH.md

# Existing patterns to follow
@static/styles.css (theme-toggle styles lines 571-617, stretched-link pattern lines 621-640)
@templates/partials/article-list.gohtml (theme-toggle HTML lines 6-22)
@templates/base.gohtml (theme toggle JS pattern lines 26-54)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS Grid Layout Styles</name>
  <files>static/styles.css</files>
  <action>
Add grid layout styles after the Article Thumbnail Styling section (after line 661). Create new section:

1. View Toggle Component (reuse theme-toggle pattern):
```css
/* View Toggle Component */
.view-toggle {
  display: inline-flex;
  background-color: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 4px;
  gap: 4px;
}

.view-toggle input[type="radio"] {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
  pointer-events: none;
}

.view-toggle label {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s ease, color 0.2s ease;
  color: var(--text-secondary);
}

.view-toggle label:hover {
  background-color: var(--bg-elevated);
}

.view-toggle input[type="radio"]:checked + label {
  background-color: var(--bg-elevated);
  color: var(--text-primary);
}

.view-toggle input[type="radio"]:focus-visible + label {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

.view-toggle svg {
  width: 18px;
  height: 18px;
}
```

2. Grid Layout Container:
```css
/* Grid Layout for Article Cards */
.articles-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1rem;
}

/* Progressive enhancement for future native masonry */
@supports (grid-template-rows: masonry) {
  .articles-grid {
    grid-template-rows: masonry;
  }
}
```

3. Grid Card Modifications:
```css
/* Grid view: vertical card layout */
.articles-grid .article-card {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  margin-bottom: 0; /* Grid handles spacing via gap */
}

/* Grid view: full-width thumbnail */
.articles-grid .article-thumbnail {
  width: 100%;
  height: auto;
  aspect-ratio: 16 / 9;
  border-radius: 6px 6px 0 0;
}

/* Grid view: content area grows to fill */
.articles-grid .article-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 0.5rem 0;
}

/* Grid view: multi-line title with clamp */
.articles-grid .article-title {
  white-space: normal;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
}

/* Grid view: favicon positioning */
.articles-grid .article-favicon {
  display: none; /* Hide favicon in grid, thumbnail is primary */
}

.articles-grid .article-thumbnail-fallback {
  width: 100%;
  height: auto;
  aspect-ratio: 16 / 9;
  border-radius: 6px 6px 0 0;
  display: flex !important;
  align-items: center;
  justify-content: center;
  background-color: var(--bg-elevated);
}

/* Grid view: action button at bottom */
.articles-grid .action-btn {
  align-self: flex-start;
  margin-top: auto;
}
```

4. Header Toggles Container (for side-by-side view and theme toggles):
```css
/* Header Toggles Container */
.header-toggles {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}
```

Do NOT modify existing .article-card styles - only add new rules scoped to .articles-grid.
Do NOT break the stretched-link pattern - keep position: relative on .article-card and z-index layering intact.
  </action>
  <verify>
Run `go run ./cmd/server` and verify:
1. Server starts without errors
2. Visit http://localhost:8080 and inspect CSS loads
3. Browser DevTools shows new CSS rules present
  </verify>
  <done>
CSS file contains .view-toggle, .articles-grid, and grid card modification rules. No syntax errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add View Toggle HTML and JavaScript</name>
  <files>templates/partials/article-list.gohtml, templates/base.gohtml</files>
  <action>
**In article-list.gohtml:**

1. Wrap the header toggles (view + theme) in a container. Replace the theme-toggle div (lines 6-22) with:
```html
<header class="main-header">
  <h1>{{if eq .CurrentFilter "read"}}Archived{{else}}Inbox{{end}}</h1>
  <div class="header-toggles">
    <div class="view-toggle" role="radiogroup" aria-label="View mode">
      <input type="radio" name="view" id="view-list" value="list">
      <label for="view-list" title="List view">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="8" y1="6" x2="21" y2="6"/>
          <line x1="8" y1="12" x2="21" y2="12"/>
          <line x1="8" y1="18" x2="21" y2="18"/>
          <line x1="3" y1="6" x2="3.01" y2="6"/>
          <line x1="3" y1="12" x2="3.01" y2="12"/>
          <line x1="3" y1="18" x2="3.01" y2="18"/>
        </svg>
        <span class="visually-hidden">List</span>
      </label>
      <input type="radio" name="view" id="view-grid" value="grid">
      <label for="view-grid" title="Grid view">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
        </svg>
        <span class="visually-hidden">Grid</span>
      </label>
    </div>
    <div class="theme-toggle" role="radiogroup" aria-label="Color theme">
      <!-- existing theme toggle content unchanged -->
    </div>
  </div>
</header>
```

2. Wrap article cards in a container with id. Find the {{range .Articles}} loop (around line 90) and wrap it:
```html
<div id="articles-container">
{{range .Articles}}
<article class="article-card" id="article-{{.ID}}">
  ... existing card content ...
</article>
{{else}}
<div class="empty-state-container">
  ... existing empty state ...
</div>
{{end}}
</div>
```

**In base.gohtml:**

1. Add FOUC prevention script for view (in head, after the theme FOUC script around line 17):
```html
<script>
(function() {
  var view = localStorage.getItem('view') || 'list';
  if (view === 'grid') {
    document.documentElement.dataset.view = 'grid';
  }
})();
</script>
```

2. Add view toggle initialization script (at end of body, after the theme script around line 54):
```html
<script>
(function() {
  var viewRadios = document.querySelectorAll('input[name="view"]');
  var stored = localStorage.getItem('view') || 'list';

  function applyView(value) {
    var container = document.getElementById('articles-container');
    if (container) {
      container.classList.toggle('articles-grid', value === 'grid');
    }
  }

  // Set initial checked state
  var initial = document.getElementById('view-' + stored);
  if (initial) initial.checked = true;

  // Apply initial view
  applyView(stored);

  function updateView(value) {
    localStorage.setItem('view', value);
    applyView(value);
  }

  viewRadios.forEach(function(r) {
    r.addEventListener('change', function(e) {
      updateView(e.target.value);
    });
  });

  // Reapply view after HTMX swaps content (articles container gets replaced)
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'main-content') {
      var current = localStorage.getItem('view') || 'list';
      applyView(current);
      // Re-bind view toggle radios in new content
      var newRadios = document.querySelectorAll('input[name="view"]');
      var currentRadio = document.getElementById('view-' + current);
      if (currentRadio) currentRadio.checked = true;
      newRadios.forEach(function(r) {
        r.addEventListener('change', function(e) {
          updateView(e.target.value);
        });
      });
    }
  });
})();
</script>
```

Do NOT modify the theme toggle JavaScript - keep it separate and working.
Do NOT change the theme toggle HTML inside the theme-toggle div - only wrap it.
  </action>
  <verify>
Run `go run ./cmd/server` and test:
1. Visit http://localhost:8080
2. View toggle appears next to theme toggle
3. Clicking grid icon switches to grid layout
4. Clicking list icon switches back to list
5. Refresh page - view preference is preserved
6. Click a sidebar filter (e.g., Archived) - grid view persists after HTMX swap
7. Search for something - grid view persists
8. Test on mobile viewport (devtools) - grid shows 1-2 columns
  </verify>
  <done>
View toggle visible next to theme toggle. Grid/list switching works. View persists in localStorage. HTMX swaps preserve view state.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete masonry-style grid layout with view toggle and localStorage persistence</what-built>
  <how-to-verify>
1. Visit http://localhost:8080
2. Verify view toggle (list/grid icons) appears next to theme toggle in header
3. Click grid icon - articles should display in responsive grid layout
4. Resize browser window:
   - Mobile (< 560px): 1 column
   - Tablet (~600-900px): 2 columns
   - Desktop (> 900px): 3-4 columns
5. Click list icon - articles return to traditional vertical list
6. In grid view, verify:
   - Thumbnails display at 16:9 aspect ratio spanning full card width
   - Titles can wrap up to 3 lines
   - Entire card is still clickable (stretched-link pattern works)
   - Read/Unread button still works
7. Refresh page - view preference should persist
8. Navigate via sidebar (Inbox/Archived/blog filter) - view preference should persist
9. Search for articles - view preference should persist
10. Test with both light and dark themes
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. Requirements coverage:
   - POLISH-02: Grid layout implemented via `.articles-grid` class with CSS Grid auto-fit
   - POLISH-03: View toggle with list/grid radio buttons in header
   - POLISH-04: localStorage persistence with HTMX afterSwap handler

2. Browser testing:
   - Chrome/Safari/Firefox: Grid layout responsive
   - Mobile viewport: Single column layout
   - Tablet viewport: 2 columns
   - Desktop viewport: 3-4 columns

3. Accessibility:
   - View toggle has aria-label="View mode"
   - Radio inputs with labels (keyboard accessible)
   - Screen reader announces "List" / "Grid" options
</verification>

<success_criteria>
1. View toggle appears next to theme toggle
2. Grid view shows articles in responsive masonry-style grid
3. List view shows traditional vertical layout (current default)
4. View preference persists across page refresh
5. View preference persists across HTMX swaps (filter, search, sync)
6. Stretched-link pattern works in grid view (full card clickable)
7. Action buttons (Read/Unread) work in grid view
8. Grid responds to viewport (1 col mobile, 2 tablet, 3-4 desktop)
</success_criteria>

<output>
After completion, create `.planning/phases/08-masonry-layout/08-01-SUMMARY.md`
</output>

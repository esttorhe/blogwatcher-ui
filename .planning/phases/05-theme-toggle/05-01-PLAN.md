---
phase: 05-theme-toggle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - static/styles.css
  - templates/base.gohtml
  - templates/partials/article-list.gohtml
autonomous: true

must_haves:
  truths:
    - "User sees three-way theme toggle (sun/computer/moon icons) in header area"
    - "User can click toggle segments and interface immediately changes theme"
    - "System mode respects OS dark/light preference"
    - "Theme preference persists across browser sessions"
    - "No flash of wrong theme on page load"
  artifacts:
    - path: "static/styles.css"
      provides: "Light theme CSS variables, toggle component styling"
      contains: "--bg-primary: #FAF8F5"
    - path: "templates/base.gohtml"
      provides: "FOUC prevention script, theme-color meta tags"
      contains: "localStorage.getItem"
    - path: "templates/partials/article-list.gohtml"
      provides: "Theme toggle radio buttons in header"
      contains: "theme-toggle"
  key_links:
    - from: "templates/base.gohtml"
      to: "static/styles.css"
      via: "CSS :has() selector reads radio button state"
      pattern: "html:has.*#theme-"
    - from: "templates/base.gohtml (inline script)"
      to: "localStorage"
      via: "Theme restoration before render"
      pattern: "localStorage.getItem.*theme"
---

<objective>
Implement three-way theme toggle (Light, Dark, System) with preference persistence.

Purpose: Allows users to switch between dark and light themes based on preference, with system-aware default that respects OS settings.

Output: Theme toggle control in header, light theme CSS variables, FOUC prevention, localStorage persistence.
</objective>

<execution_context>
@/Users/esteban.torres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/esteban.torres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-theme-toggle/05-CONTEXT.md
@.planning/phases/05-theme-toggle/05-RESEARCH.md

Key existing files:
@static/styles.css - CSS with dark theme variables (to be extended)
@templates/base.gohtml - Base template with head section (add FOUC script)
@templates/partials/article-list.gohtml - Header area where toggle goes
</context>

<tasks>

<task type="auto">
  <name>Task 1: CSS Light Theme Variables and Toggle Component Styling</name>
  <files>static/styles.css</files>
  <action>
Add light theme CSS variables and theme toggle styling to styles.css:

1. Add light theme as new default in :root (warm cream colors from RESEARCH.md):
   - --bg-primary: #FAF8F5 (warm cream)
   - --bg-surface: #FFFFFF (white cards)
   - --bg-elevated: #F5F3F0 (slightly darker cream)
   - --text-primary: #37352F (Notion-like dark charcoal)
   - --text-secondary: #6B6B6B (medium gray)
   - --accent: #2563EB (blue for contrast on cream)
   - --border: #E5E3E0 (warm light border)

2. Move existing dark theme variables under html.dark selector.

3. Add CSS :has() rules for theme application:
   ```css
   /* Dark mode when explicitly selected */
   html:has(#theme-dark:checked) { /* dark variables */ }

   /* Dark mode when system preference and system selected */
   @media (prefers-color-scheme: dark) {
     html:has(#theme-system:checked) { /* dark variables */ }
   }
   ```

4. Add theme toggle component styling:
   - .theme-toggle: inline-flex container with border, border-radius 8px, padding 4px
   - Hide radio inputs (position absolute, opacity 0, pointer-events none)
   - Style labels as clickable segments (padding 6px 10px, border-radius 6px, cursor pointer)
   - Active state: input:checked + label gets --bg-elevated background
   - Focus state: focus-visible + label gets outline with --accent
   - SVG icons: 18px width/height

5. Add theme transition for smooth switching:
   ```css
   html {
     transition: background-color 0.2s ease, color 0.2s ease;
   }
   ```
   Include prefers-reduced-motion media query to disable transitions.

6. Position toggle in header: Add .main-header class with flexbox (justify-content: space-between, align-items: center) for h1 and toggle positioning.

DO NOT remove existing dark theme values. Move them to html.dark selector.
DO NOT change existing element styling - only add theme variable structure and toggle component.
  </action>
  <verify>
Open static/styles.css and confirm:
- Light theme variables in :root
- Dark theme variables in html.dark selector
- CSS :has() rules for #theme-dark:checked and #theme-system:checked
- .theme-toggle component styles with hidden inputs and styled labels
- .main-header flexbox class exists
  </verify>
  <done>
CSS contains light theme variables (warm cream), dark theme variables (existing), :has() selectors for theme switching, and theme toggle component styling with proper accessibility (focus states).
  </done>
</task>

<task type="auto">
  <name>Task 2: Theme Toggle HTML, FOUC Prevention Script, and Persistence</name>
  <files>templates/base.gohtml, templates/partials/article-list.gohtml</files>
  <action>
1. In templates/base.gohtml, add inline FOUC prevention script immediately after opening head tag (BEFORE stylesheet link):

```html
<script>
(function() {
  var theme = localStorage.getItem('theme') || 'system';
  var isDark = theme === 'dark' ||
    (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
  if (isDark) {
    document.documentElement.classList.add('dark');
  }
})();
</script>
```

2. In templates/base.gohtml, add theme-color meta tags with media queries for browser chrome:
```html
<meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#FAF8F5" media="(prefers-color-scheme: light)">
```

3. In templates/base.gohtml, remove class="dark" from html element (script will add it dynamically).

4. In templates/base.gohtml, add theme persistence script before closing body tag:
```html
<script>
(function() {
  var radios = document.querySelectorAll('input[name="theme"]');
  var stored = localStorage.getItem('theme') || 'system';

  // Set initial checked state
  var initial = document.getElementById('theme-' + stored);
  if (initial) initial.checked = true;

  function updateTheme(value) {
    localStorage.setItem('theme', value);
    var isDark = value === 'dark' ||
      (value === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
    document.documentElement.classList.toggle('dark', isDark);
  }

  radios.forEach(function(r) {
    r.addEventListener('change', function(e) {
      updateTheme(e.target.value);
    });
  });

  // Listen for system preference changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
    var current = localStorage.getItem('theme') || 'system';
    if (current === 'system') {
      updateTheme('system');
    }
  });
})();
</script>
```

5. In templates/partials/article-list.gohtml, wrap the h1 in a header element with toggle:

Replace:
```html
<h1>{{if eq .CurrentFilter "read"}}Archived{{else}}Inbox{{end}}</h1>
```

With:
```html
<header class="main-header">
  <h1>{{if eq .CurrentFilter "read"}}Archived{{else}}Inbox{{end}}</h1>
  <div class="theme-toggle" role="radiogroup" aria-label="Color theme">
    <input type="radio" name="theme" id="theme-light" value="light">
    <label for="theme-light" title="Light theme">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      <span class="visually-hidden">Light</span>
    </label>
    <input type="radio" name="theme" id="theme-system" value="system" checked>
    <label for="theme-system" title="System theme">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      <span class="visually-hidden">System</span>
    </label>
    <input type="radio" name="theme" id="theme-dark" value="dark">
    <label for="theme-dark" title="Dark theme">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      <span class="visually-hidden">Dark</span>
    </label>
  </div>
</header>
```

SVG icons are from Feather Icons (MIT license): sun, monitor, moon.

DO NOT use async or defer on the FOUC prevention script - it must block rendering.
DO NOT change the existing HTMX script loading.
  </action>
  <verify>
1. Start server: `go run ./cmd/server`
2. Open http://localhost:8080 in browser
3. Verify theme toggle appears in header (top right of main content)
4. Click Light - interface switches to warm cream background
5. Click Dark - interface switches to dark background
6. Click System - interface matches OS preference
7. Refresh page - selected theme persists (no flash of wrong theme)
8. Change OS dark mode setting - interface updates if System is selected
  </verify>
  <done>
Theme toggle renders with sun/computer/moon icons, clicking segments changes theme, preference saved to localStorage, page load restores preference without flash, System mode responds to OS preference changes.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Visual verification:
   - Theme toggle visible in header area (right side)
   - Three segments with sun/computer/moon icons
   - Active segment has distinct background

2. Functional verification:
   - Light mode: Warm cream background (#FAF8F5), dark text
   - Dark mode: Dark background (#121212), light text
   - System mode: Matches OS preference

3. Persistence verification:
   - Select Light, refresh page - stays Light
   - Select Dark, refresh page - stays Dark
   - Close browser, reopen - preference persists

4. FOUC verification:
   - Select Dark mode
   - Hard refresh (Cmd+Shift+R) - no white flash

5. Accessibility verification:
   - Tab to toggle - focus ring visible
   - Screen reader announces "Color theme" radiogroup
   - Each option has accessible name (Light/System/Dark)
</verification>

<success_criteria>
- User sees theme toggle in header with sun/computer/moon icons
- Clicking Light segment: warm cream background, dark charcoal text
- Clicking Dark segment: dark background (#121212), light text
- Clicking System segment: matches OS dark/light preference
- Refreshing page: selected theme persists without flash
- Changing OS preference while System selected: theme updates
- Keyboard accessible: can tab and select with arrow keys
</success_criteria>

<output>
After completion, create `.planning/phases/05-theme-toggle/05-01-SUMMARY.md`
</output>
